#!/usr/bin/env bash

# ⚠️  DESTRUCTIVE TEST SCRIPT - CONTAINER ONLY ⚠️
#
# E2E Test: Fresh NPM Installation
# Tests SWIC installation from scratch, CLI commands, and lazy folder creation
#
# This script deletes ~/.swic and .swic directories!
# It MUST only run inside Docker containers.
#
# Safety mechanisms:
# 1. File has .dont.run.on.host extension on host (prevents execution)
# 2. Dockerfile strips extension during build (executable in container)
# 3. Runtime check below (backup safety - validates container environment)
#
# NEVER run this script directly on your host machine!
# Use: bash tests/e2e/run-e2e-tests.sh (which runs in Docker)

set -e  # Exit on error

# Source shared safety check
source "$(dirname "$0")/../../lib/safety-check.sh"
verify_container_environment

TEST_NAME="npm-project-fresh"
FAILED=0

echo "========================================="
echo "Test: $TEST_NAME"
echo "========================================="
echo ""

# Function to log test steps
log_step() {
    echo "➤ $1"
}

# Function to log success
log_success() {
    echo "  ✓ $1"
}

# Function to log failure and mark test as failed
log_failure() {
    echo "  ✗ $1"
    FAILED=1
}

# Function to verify directory exists
verify_dir() {
    if [ -d "$1" ]; then
        log_success "Directory exists: $1"
    else
        log_failure "Directory missing: $1"
    fi
}

# Function to verify file exists
verify_file() {
    if [ -f "$1" ]; then
        log_success "File exists: $1"
    else
        log_failure "File missing: $1"
    fi
}

# Fresh container starts clean - no cleanup needed
log_step "Starting with clean container environment"
log_success "Clean slate"

# Configure npm with read-only token via environment variable
if [ -n "${SWIC_CLIBUILDER_READ_ACCESS:-}" ]; then
    export NODE_AUTH_TOKEN="${SWIC_CLIBUILDER_READ_ACCESS}"
    npm config set @kelceyp:registry https://registry.npmjs.org/ --location=project
    npm config set //registry.npmjs.org/:_authToken "${NODE_AUTH_TOKEN}" --location=project
fi

# Test 1: Install @kelceyp/swic
log_step "Installing @kelceyp/swic from npm"
npm install @kelceyp/swic --save-dev --loglevel=error

if [ $? -eq 0 ]; then
    log_success "Installation successful"
else
    log_failure "Installation failed"
    exit 1
fi

# Verify node_modules
verify_dir "node_modules/@kelceyp/swic"
verify_file "node_modules/@kelceyp/swic/package.json"

# Test 2: Verify CLI is accessible
log_step "Verifying CLI accessibility"
if npx swic doc list --scope project &>/dev/null || npx swic doc list --scope project 2>&1 | grep -q "No docs found"; then
    log_success "CLI is accessible via npx"
else
    log_failure "CLI not accessible"
fi

# Test 3: Verify lazy folder creation - project scope
log_step "Verifying lazy folder creation (project scope)"
verify_dir ".swic/docs"

# Test 4: Verify lazy folder creation - shared scope
log_step "Verifying lazy folder creation (shared scope)"
verify_dir "$HOME/.swic/docs"

# Test 5: Create a doc in project scope
log_step "Creating a project doc"
npx swic doc create test-doc --scope project --content "# Test Document

This is a test." > /dev/null

if [ $? -eq 0 ]; then
    log_success "Doc created successfully"
else
    log_failure "Failed to create doc"
fi

# Test 6: Verify doc was created and has index
log_step "Verifying doc creation"
verify_file ".swic/docs/.index.json"

# Test 7: Read the doc back
log_step "Reading the doc"
CONTENT=$(npx swic doc read test-doc --scope project)

if echo "$CONTENT" | grep -q "Test Document"; then
    log_success "Doc content verified"
else
    log_failure "Doc content incorrect"
fi

# Test 8: List docs
log_step "Listing docs"
LIST_OUTPUT=$(npx swic doc list --scope project)

if echo "$LIST_OUTPUT" | grep -q "test-doc"; then
    log_success "Doc appears in list"
else
    log_failure "Doc not in list"
fi

# Test 9: Create a shared doc
log_step "Creating a shared doc"
npx swic doc create global-test --scope shared --content "# Global Test

Shared doc." > /dev/null

if [ $? -eq 0 ]; then
    log_success "Shared doc created"
else
    log_failure "Failed to create shared doc"
fi

# Verify shared doc location
verify_file "$HOME/.swic/docs/.index.json"

# Test 10: Delete docs
log_step "Deleting docs"
npx swic doc delete test-doc --scope project --confirm > /dev/null
npx swic doc delete global-test --scope shared --confirm > /dev/null

if [ $? -eq 0 ]; then
    log_success "Docs deleted successfully"
else
    log_failure "Failed to delete docs"
fi

# Test 11: Verify deletion
log_step "Verifying deletion"
LIST_OUTPUT=$(npx swic doc list --scope project)

if ! echo "$LIST_OUTPUT" | grep -q "test-doc"; then
    log_success "Project doc deleted"
else
    log_failure "Project doc still exists"
fi

SHARED_LIST_OUTPUT=$(npx swic doc list --scope shared)

if ! echo "$SHARED_LIST_OUTPUT" | grep -q "global-test"; then
    log_success "Shared doc deleted"
else
    log_failure "Shared doc still exists"
fi

# ========================================
# MCP TESTS via Claude CLI
# ========================================
echo ""
echo "========================================="
echo "MCP Tests (via claude -p)"
echo "========================================="

# Test MCP 1: Verify .mcp.json is valid and swic tools are registered
log_step "Verifying MCP configuration"
MCP_TOOLS_OUTPUT=$(claude --dangerously-skip-permissions --mcp-config .mcp.json -p "List all available MCP tools that start with 'swic' or 'mcp__swic'. Just output the tool names, one per line, nothing else." 2>&1 || true)

if echo "$MCP_TOOLS_OUTPUT" | grep -q "swic\|mcp__swic"; then
    log_success "SWIC MCP tools registered"
else
    log_failure "SWIC MCP tools not found. Output: $MCP_TOOLS_OUTPUT"
fi

# Test MCP 2: Create a doc via MCP
log_step "Creating doc via MCP (doc_create)"
MCP_CREATE_OUTPUT=$(claude --dangerously-skip-permissions --mcp-config .mcp.json -p "Use the mcp__swic__doc_create tool to create a document with scope='project', path='mcp-test/created', and content='Created via MCP'. Report only the doc ID that was created, nothing else." 2>&1 || true)

if echo "$MCP_CREATE_OUTPUT" | grep -q "doc[0-9]"; then
    log_success "Created doc via MCP"
else
    log_failure "Failed to create doc via MCP. Output: $MCP_CREATE_OUTPUT"
fi

# Test MCP 3: Read the doc via MCP
log_step "Reading doc via MCP (doc_read)"
MCP_READ_OUTPUT=$(claude --dangerously-skip-permissions --mcp-config .mcp.json -p "Use the mcp__swic__doc_read tool to read the document at path 'mcp-test/created' in project scope. Report only the content of the document, nothing else." 2>&1 || true)

if echo "$MCP_READ_OUTPUT" | grep -q "Created via MCP"; then
    log_success "Read doc via MCP"
else
    log_failure "Failed to read doc via MCP. Output: $MCP_READ_OUTPUT"
fi

# Test MCP 4: List docs via MCP
log_step "Listing docs via MCP (doc_list)"
MCP_LIST_OUTPUT=$(claude --dangerously-skip-permissions --mcp-config .mcp.json -p "Use the mcp__swic__doc_list tool to list all documents in project scope. Report only the number of documents found, nothing else." 2>&1 || true)

if echo "$MCP_LIST_OUTPUT" | grep -q "[0-9]"; then
    log_success "Listed docs via MCP"
else
    log_failure "Failed to list docs via MCP. Output: $MCP_LIST_OUTPUT"
fi

# Test MCP 5: Edit the doc via MCP
log_step "Editing doc via MCP (doc_edit)"
MCP_EDIT_OUTPUT=$(claude --dangerously-skip-permissions --mcp-config .mcp.json -p "Use the mcp__swic__doc_edit tool to edit the document at path 'mcp-test/created' in project scope. Use operation type 'replaceOnce' to replace 'MCP' with 'Claude'. Report only 'success' if it worked, nothing else." 2>&1 || true)

if echo "$MCP_EDIT_OUTPUT" | grep -qi "success"; then
    log_success "Edited doc via MCP"
else
    log_failure "Failed to edit doc via MCP. Output: $MCP_EDIT_OUTPUT"
fi

# Test MCP 6: Verify edit worked
log_step "Verifying edit via CLI"
VERIFY_EDIT=$(npx swic doc read mcp-test/created --scope project 2>&1 || true)

if echo "$VERIFY_EDIT" | grep -q "Created via Claude"; then
    log_success "Edit verified - content updated"
else
    log_failure "Edit verification failed. Content: $VERIFY_EDIT"
fi

# Test MCP 7: Delete the doc via MCP
log_step "Deleting doc via MCP (doc_delete)"
MCP_DELETE_OUTPUT=$(claude --dangerously-skip-permissions --mcp-config .mcp.json -p "Use the mcp__swic__doc_delete tool to delete the document at path 'mcp-test/created' in project scope. Report only 'success' if it worked, nothing else." 2>&1 || true)

if echo "$MCP_DELETE_OUTPUT" | grep -qi "success"; then
    log_success "Deleted doc via MCP"
else
    log_failure "Failed to delete doc via MCP. Output: $MCP_DELETE_OUTPUT"
fi

# Test MCP 8: Verify deletion
log_step "Verifying deletion via CLI"
VERIFY_DELETE=$(npx swic doc list --scope project 2>&1 || true)

if ! echo "$VERIFY_DELETE" | grep -q "mcp-test/created"; then
    log_success "Deletion verified"
else
    log_failure "Doc still exists after deletion"
fi

echo ""
echo "MCP tests completed"
echo ""

# Summary
echo ""
echo "========================================="
if [ $FAILED -eq 0 ]; then
    echo "✅ $TEST_NAME: ALL TESTS PASSED"
    echo "========================================="
    exit 0
else
    echo "❌ $TEST_NAME: SOME TESTS FAILED"
    echo "========================================="
    exit 1
fi
